<!DOCTYPE html>
<html lang="en">

<head>
    <title>Synoptophor VR</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://unpkg.com/gl-matrix@2.8.1/dist/gl-matrix-min.js"></script>
    <script src="https://unpkg.com/vue@3.0.11"></script>
    <script src="vr.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .app {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 500px;
        }

        .canvas {
            flex-basis: 0;
            min-height: 0;
        }

        .error {
            color: red;
        }

        .row {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .row .grow {
            flex-grow: 1;
        }

        .w130px {
            width: 130px
        }

        .mt2 {
            margin-top: 16px;
        }

        .ml1 {
            margin-left: 8px
        }

        .h50px {
            height: 50px;
        }

        .w100 {
            width: 100%;
        }
    </style>
</head>

<body>
<div id="app" class="app"></div>

</body>
<script type="module">
    const setAbortableTimeout = (handler, timeout, abortSignal) => {
        if (abortSignal?.aborted) {
            return;
        }
        let timeoutId;
        const abortListener = () => {
            clearTimeout(timeoutId);
        };
        abortSignal?.addEventListener("abort", abortListener);
        timeoutId = setTimeout(() => {
            abortSignal?.removeEventListener("abort", abortListener);
            handler();
        }, timeout);
    };
    const easeInOutSine = x => -(Math.cos(Math.PI * x) - 1) / 2;
    Vue.createApp({
        // language=Vue
        template: `
            <canvas id="canvas" class="canvas"></canvas>
            <div class="row w100">
                <button type="button" class="h50px grow" v-on:click="onStartVr" v-bind:disabled="vr.running">
                    Start VR
                </button>
                <button type="button" class="h50px ml1" v-on:click="vr.stopVrSession()" v-bind:disabled="!vr.running">
                    Stop VR
                </button>
            </div>
            <div class="error row mt2" v-if="error">
                {{ error }}
            </div>
            <div class="row mt2">
                <label><input type="radio" id="mode" value="moving" v-model="mode">Moving</label>
                <label><input class="ml1" type="radio" id="mode" value="fixed" v-model="mode">Fixed</label>
            </div>
            <fixed-rotation-panel
                v-if="mode === 'fixed'"
                v-bind:vr="vr"></fixed-rotation-panel>
            <moving-rotation-panel
                v-if="mode === 'moving'"
                v-bind:vr="vr"></moving-rotation-panel>
        `,
        data() {
            return {
                error: null,
                vr: new Vr(document.getElementById("canvas")),
                mode: "moving"
            };
        },
        mounted() {
            window.addEventListener("keydown", keyboardEvent => {
                if (keyboardEvent.key === "Escape" && this.vr.running) {
                    this.vr.stopVrSession();
                }
            });
        },
        methods: {
            async onStartVr() {
                try {
                    await this.vr.startXrSession();
                } catch (e) {
                    console.error(e);
                    this.error = e.message;
                }
            },
        },
    }).component("fixed-rotation-panel", {
        // language=Vue
        template: `
            <div class="row mt2">
                <div class="w130px">Horizontal angle:</div>
                <input type="number"
                       step="0.1"
                       :value="String(rotationY)"
                       @input="setRotationY(toNumber($event.target.value))">
            </div>
            <div class="row mt2">
                <div class="w130px">Vertical angle:</div>
                <input type="number"
                       step="0.1"
                       :value="String(rotationX)"
                       @input="setRotationX(toNumber($event.target.value))">
            </div>
        `,
        props: {
            vr: {type: Vr, required: true},
        },
        data() {
            return {
                rotationX: Number(localStorage.getItem("VR.fixed.rotationX") || "0"),
                rotationY: Number(localStorage.getItem("VR.fixed.rotationY") || "0"),
                rotationAnimation: null,
            };
        },
        mounted() {
            this.vr.rotationX = this.rotationX;
            this.vr.rotationY = this.rotationY;
        },
        beforeUnmount() {
            this.rotationAnimation?.stop();
        },
        methods: {
            setRotationX(newRotationX) {
                localStorage.setItem("VR.fixed.rotationX", newRotationX);
                this.vr.rotationX = newRotationX;
                this.rotationX = newRotationX;
            },
            setRotationY(newRotationY) {
                localStorage.setItem("VR.fixed.rotationY", newRotationY);
                this.vr.rotationY = newRotationY;
                this.rotationY = newRotationY;
            },
            toNumber(string) {
                const number = string ? Number(string) : 0;
                return Number.isFinite(number) ? number : 0;
            }
        }
    }).component("moving-rotation-panel", {
        // language=Vue
        template: `
            <div class="row mt2">
                <div class="w130px">Duration:</div>
                <input type="number"
                       step="0.1"
                       :value="String(duration)"
                       @input="duration = toNumber($event.target.value)">
            </div>
            <div class="row mt2">
                <div class="w130px">Pause:</div>
                <input type="number"
                       step="0.1"
                       :value="String(pause)"
                       @input="pause = toNumber($event.target.value)">
            </div>
            <div class="row mt2">
                <div class="w130px">Horizontal angle:</div>
                <input type="number"
                       step="0.1"
                       :value="String(fromRotationY)"
                       @input="fromRotationY = toNumber($event.target.value)">
                <input class="ml1"
                       type="number"
                       step="0.1"
                       :value="String(toRotationY)"
                       @input="toRotationY = toNumber($event.target.value)">
            </div>
            <div class="row mt2">
                <div class="w130px">Vertical angle:</div>
                <input type="number"
                       step="0.1"
                       :value="String(fromRotationX)"
                       @input="fromRotationX = toNumber($event.target.value)">
                <input class="ml1"
                       type="number"
                       step="0.1"
                       :value="String(toRotationX)"
                       @input="toRotationX = toNumber($event.target.value)">
            </div>
            <div class="row mt2">
                <button type="button"
                        v-on:click="onStartMoving"
                        v-bind:disabled="vr.hasAnimation">
                    Start
                </button>
                <button type="button"
                        v-on:click="onStopMoving"
                        v-bind:disabled="!vr.hasAnimation">
                    Stop
                </button>
            </div>
        `,
        props: {
            vr: {type: Vr, required: true},
        },
        data() {
            return {
                duration: Number(localStorage.getItem("VR.moving.duration") || "0"),
                pause: Number(localStorage.getItem("VR.moving.pause") || "0"),
                fromRotationX: Number(localStorage.getItem("VR.moving.fromRotationX") || "0"),
                toRotationX: Number(localStorage.getItem("VR.moving.toRotationX") || "0"),
                fromRotationY: Number(localStorage.getItem("VR.moving.fromRotationY") || "0"),
                toRotationY: Number(localStorage.getItem("VR.moving.toRotationY") || "0"),
            };
        },
        mounted() {
            this.vr.rotationX = this.fromRotationX;
            this.vr.rotationY = this.fromRotationY;
        },
        beforeUnmount() {
            this.onStopMoving();
        },
        watch: {
            duration(newDuration) {
                localStorage.setItem("VR.moving.duration", String(newDuration));
            },
            pause(newPause) {
                localStorage.setItem("VR.moving.pause", String(newPause));
            },
            fromRotationX(newFromRotationX) {
                localStorage.setItem("VR.moving.fromRotationX", String(newFromRotationX));
            },
            toRotationX(newToRotationX) {
                localStorage.setItem("VR.moving.toRotationX", String(newToRotationX));
            },
            fromRotationY(newFromRotationY) {
                localStorage.setItem("VR.moving.fromRotationY", String(newFromRotationY));
            },
            toRotationY(newToRotationY) {
                localStorage.setItem("VR.moving.toRotationY", String(newToRotationY));
            },
        },
        methods: {
            onStartMoving() {
                this.vr.setAnimation(async (animate, abortSignal) => {
                    while (!abortSignal.aborted) {
                        this.vr.rotationX = this.fromRotationX;
                        this.vr.rotationY = this.fromRotationY;
                        await animate({
                            duration: this.duration * 1000,
                            timing: easeInOutSine,
                            onUpdate: progress => {
                                this.vr.rotationX = this.fromRotationX + (this.toRotationX - this.fromRotationX) * progress;
                                this.vr.rotationY = this.fromRotationY + (this.toRotationY - this.fromRotationY) * progress;
                            },
                            abortSignal,
                        });
                        await new Promise(resolve => setAbortableTimeout(resolve, this.pause * 1000, abortSignal));
                        await animate({
                            duration: this.duration * 1000,
                            timing: easeInOutSine,
                            onUpdate: progress => {
                                this.vr.rotationX = this.toRotationX + (this.fromRotationX - this.toRotationX) * progress;
                                this.vr.rotationY = this.toRotationY + (this.fromRotationY - this.toRotationY) * progress;
                            },
                            abortSignal,
                        });
                        await new Promise(resolve => setAbortableTimeout(resolve, this.pause * 1000, abortSignal));
                    }
                });
            },
            onStopMoving() {
                this.vr.setAnimation(null);
            },
            toNumber(string) {
                const number = string ? Number(string) : 0;
                return Number.isFinite(number) ? number : 0;
            }
        }
    }).mount("#app");
</script>

</html>
